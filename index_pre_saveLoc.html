<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>aSCRIBEa&#8482;</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="./favicon.ico" />
    <!-- <script src="./data/default_data.js"></script>****************LOAD-CUSTOM-DATA-MODULE****************** -->
    <script  > //****************IMPORT _default_ DATA-MODULE******************
        // let _default_TICKR_DATA_MAP_Monthly = default_TICKR_DATA_MAP_Monthly
        // let _default_TRADE_DATA_MAP_Monthly = default_TRADE_DATA_MAP_Monthly
        // let _default_MOMZ_DATA_MAP = default_MOMZ_DATA_MAP
    </script>  <!-- **************************END-CUSTOM-DATA-MODULE******************-->
    <style>

body {
    background-color: black;
    color: steelblue;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    flex-direction: column;
    /* height: 100%; */
    height: 100vh;
    /* padding-top: 1em; */
    /* padding-bottom: 1em; */
    font-family: Arial, sans-serif;
    overflow: hidden;
    min-height: 100vh;
    margin:0;
}

#renderTokenFrame {
    width: 98%;
    height: 444px;
    border: 1px solid steelblue;
    overflow-y: auto;
    padding: 10px;
    background: black;
    scroll-behavior: smooth;
    border-radius: 18px;
    margin-right: 2em;
    display: flex; 
    flex-direction: column;
}

.token-row {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    border: 1px solid #310131;
    border-radius: 22px
}

.token-row:hover {
    transform: translateX(5px);
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
}

.row-number {
    color: steelblue;
    font-size: 0.8em;
    margin-right: 8px;
    min-width: 30px;
}

.row-content {
    flex-grow: 1;
    padding: 4px;
    padding-left: 1em;
    padding-right: 1em;
    border-radius: 25px;
    border: 1px solid steelblue;
}

.token-text {
    margin-left: 12px;
}
.controls {
    /* padding: 10px; */
    /* background: #eee; */
    /* border: 1px solid #ddd; */
    /* margin-top: 10px; */
    /* display: flex; */
    /* gap: 20px; */
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 8px;
    padding-bottom:10px;
    background:black;
    border:1px solid steelblue;
    border-radius: 13px;
}
.controlBar {
    padding: 10px;
    background: black;
    border: solid 1px lime;
    border-radius: 17px;
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
}

/* .control-group {
    display: flex;
    align-items: center;
    gap: 8px;
} */

.commonTXTAREA:focus-visible {
    outline: none;
    border: 1px solid dodgerblue;
}
.commonTXTAREA {
    width: 100%;
    background: #111;
    color: lime;
    border: 1px solid aqua;
    border-radius: 13px;
    padding: 1em;
    font-size: 16px;
    resize: vertical;
    box-sizing: border-box;
    line-height: 1.5;
    margin:0.222em 0 0.222em 0;
}
select {
    padding: 4px;
    border-radius: 4px;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-right: 8px;
}

#autoScrollBtn {
    padding: 8px 16px;
    background: #073008;
    color: white;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

#autoScrollBtn:hover {
    background: #45a049;
}

#autoScrollBtn.active {
    background: #f44336;
}

/**********************Inline Edit Style**********************/
.edit-input{
    color:aqua !important;
    margin-bottom:0.222em !important;
    font-size: 14px !important;
    width: 100% !important;
    line-height: 1em !important;
}

.save-btn .cancel-btn{
    font-size:16px !important;
}
/**********************END Inline Edit Style**********************/

/* CUSTOM CHECKBOX *************************************************/
.checkboxFrame {
    display:flex;position:relative;padding: 0em 0em 0.666em 0em;margin: 0em 1em 0em 1em;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.checkboxFrame input {/* Hide the browser's default checkbox */
    position: absolute;opacity: 0;cursor: pointer;height: 0;width: 0;
}      
.checkmark {
    border:1px solid lime;border-radius:3px;position: absolute;
    top: 0;left: 0;height: 10px;width: 10px;
    background-color: black; box-shadow: 0px 2px 6px 1px #010191;  
}
.checkboxFrame:hover input ~ .checkmark { background-color: #014601;}
.checkboxFrame input:checked ~ .checkmark {  background-color: steelblue;}
.checkmark:after {content: "";position: absolute;display: none;}
.checkboxFrame input:checked ~ .checkmark:after { display: block;}
.checkboxFrame .checkmark:after {left: 4px;top: -1px;width: 2px;height: 6px;
    border: solid #014601;border-width: 0 3px 3px 0;
    -webkit-transform: rotate(45deg);
    -ms-transform: rotate(45deg);
    transform: rotate(45deg);
}

.aNUMBOX1{
    display: flex;
    align-items: center;
    font-size: 0.666em;
    margin-right: 1em;
}
/**END CUSTOM CHECKBOX******************************************************/
/* ***********************************CUSTOM SCROLLBAR****************************/
.scrollBarV {overflow-x:scroll;}
.scrollBarV::-webkit-scrollbar-track { background-color: #010213;  border-radius: 13px; }
.scrollBarV::-webkit-scrollbar { width: 0.666em; height: 100%; }
.scrollBarV::-webkit-scrollbar-thumb { background-color: #04223c; border-radius: 13px;
    background-image: -webkit-linear-gradient(0deg, rgba(255, 255, 255, 0.6) 26%, transparent 26%, transparent 51%, rgba(255, 255, 255, -0.4) 51%, rgba(255, 255, 255, 0.6) 74%, transparent 74%, transparent);
}             

.app-frame {
    width: 90%;
    /* height: 90vw; */
    border: 2px solid aqua;
    border-radius: 13px;
    padding: 20px;
    position: relative;
    /* flex:1; */
    width: 90%;
    height: calc(100vh - 166px); /* Adjust 166px based on nav height + margins */
    max-height: calc(100vh - 166px);
    border: 2px solid aqua;
    border-radius: 13px;
    padding: 20px;
    position: relative;
    overflow-y: auto;
    margin-bottom: 20px;
}

#text-display {
    width: 100%;
    height: 60vh;
    background-color: #111;
    color: steelblue;
    border: 1px solid aqua;
    border-radius: 13px;
    padding: 1em 2% 1em 2%;
    font-size: 16px;
    resize: vertical;
    box-sizing: border-box;
    line-height: 1.5;
}


.control-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

button {
    background-color: #222;
    color: steelblue;
    border: 1px solid aqua;
    border-radius: 13px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 100px;
}

button:hover {
    background-color: #333;
    color: aqua;
}

button:active {
    background-color: #111;
}

.control-group {
    display: flex;
    align-items: baseline;
    gap: 8px;
    font-size:0.888em;
}

select, input[type="text"] {
    background-color: #222;
    color: steelblue;
    border: 1px solid aqua;
    border-radius: 13px;
    padding: 8px;
    padding-left:1em;
    cursor: pointer;
    outline: none;
    width: 100%;
}

select{font-size: 1em;}
button{font-size: 0.888em;}

select:hover, input[type="text"]:hover {
    background-color: #333;
}

option {
    background-color: #111;
}

.label {
    color: steelblue;
    font-size: 16px;
    min-width: 50px;
    text-align: center;
}

.title-display {
    font-size: 18px;
    font-weight: bold;
    min-width: 150px;
    text-align: center;
}

.keyboard-hint {
    text-align: center;
    color: #666;
    font-size: 14px;
    margin-top: 10px;
    font-style: italic;
}

nav {
    position: sticky;
    bottom: 0;
    background: black;
    z-index: 100;
    padding: 10px 0;
}

    /* ************* CUSTOM MOBILE ***********************/
    @media only screen and (max-width: 500px) { /************* PHONE */
        .mainBtn{ font-size:0.666em; min-width:0; }
        #NAV_MENU{justify-content:center;}
        .control-group{font-size: 0.666em;}
        select{font-size: 0.999em;}
        button{font-size: 0.666em;}
    }

.size-btn {
    background: #073008;
    color: lime;
    border: 1px solid lime;
    border-radius: 22px;
    cursor: pointer;
    padding: 5px 10px;
    margin-left: 5px;
    min-width: 50px;
}

.maximized {
    height: calc(100vh - 322px) !important;
}

.hidden {
    display: none !important;
}
</style>
</head>
<body>

    
    <h1 style="margin: 0px; display: flex; width: 100%; justify-content: center; 
    font-size: 0.888em; color: steelblue;margin: 8px 0 8px 0;">aSCRIBEa</h1>

<article id="NAV_INFO" class="app-frame scrollBarV" style="display:none;">
    <h2 style="align-self: flex-start; color: steelblue; 
    font-size: 1em;">ABOUT</h2>
    <div style="border: 1px solid aqua; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; gap: 10px;">
        <div class="control-group">
            <label for="">Overview:</label>
            <section>this app is a music lyric rich text editor,
                but it can be used for so much more! </section>
        </div>
        <div class="control-group">
            <label for="txt">TXT:</label>
            <textarea id="" class="commonTXTAREA  scrollBarV" placeholder="Enter text..." rows="4"></textarea>
        </div>
        <div class="control-group">
            <label for="version">Version:</label>
            <input type="text" id="" placeholder="Enter version...">
        </div>
        <div class="control-group">
            <label for="description">Description:</label>
            <textarea id="" class="commonTXTAREA  scrollBarV" placeholder="Enter description..." rows="4"></textarea>
        </div>
        <div class="control-group" style="display: flex; flex-direction: column;">
            <label for="metadata">Metadata:</label>
            <textarea id="" class="commonTXTAREA  scrollBarV" placeholder="Enter metadata..." rows="4"></textarea>
        </div>
    </div>
</article><!--END INFO VIEW-->
<article id="NAV_EDIT" class="app-frame scrollBarV" style="display:none;">
    <h2 style="align-self: flex-start; color: steelblue;
    font-size: 1em;">EDIT</h2>
    <section style="border: 1px solid aqua; border-radius: 10px; 
    display: flex; flex-direction: column; gap: 10px;
    padding: 1em 5%">
    <div class="control-row" style="justify-content: space-between;">
        <label for="song_title">Title:</label>
        <input id="EDIT_TXT_TITLE" type="text" id="song_title" placeholder="Enter song title..."
        style="color:burlywood;width:50% ">
        <button onclick="EDIT_prevTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;"><</button>
        <button onclick="EDIT_nextTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;">></button>
    </div>
    <div class="control-group" style="display: flex; flex-direction: column;">
        <label for="txt">TXT:</label>
        <textarea id="EDIT_TXT_TXT" class="commonTXTAREA  scrollBarV" 
        placeholder="Enter text..." rows="4"
        style="height:222px;"></textarea>
    </div>
    <div class="control-group">
        <label for="version">Version:</label>
        <input id="EDIT_TXT_VERSION" type="text" id="version" placeholder="Enter version..."
        style="color:aqua;">
    </div>
    <div class="control-group" style="display: flex; flex-direction: column;
        margin-top:0.222em;">
        <label for="description">Description:</label>
        <textarea id="EDIT_TXT_DESCRIPTION" class="commonTXTAREA  scrollBarV" 
        placeholder="Enter description..." rows="4"
        style="color:plum;height: 88px;"></textarea>
    </div>
    <div class="control-group" style="display: flex; flex-direction: column;
        margin-top:0.222em;">
        <label for="metadata">Metadata:</label>
        <textarea id="EDIT_TXT_METADATA" class="commonTXTAREA  scrollBarV" 
        placeholder="Enter metadata..." rows="4"
        style="color:steelblue;height: 88px;"></textarea>
    </div>      

    </section>
    <div class="control-row">
        <div class="controlBar" style="border:1px solid steelblue; border-radius:13px;">

            <div class="control-group">
                <button onclick="newTXT()">New</button>
                <button onclick="saveTXT_EDIT()">Save</button>
                <button onclick="deleteTXT()">Delete</button>
                <button onclick="saveTXT_EDIT(); showPLAYBACK();">Render</button>
            </div>
            <script>
                let TXT_IDX = 0; //index of current document
                let TXT_DOC_DATA = [
                    {title: 'txt1', txt: `text 1
                    
                    [something]
                    
                    (secondary)
                    
                    aTHIRDZa
                    
                    UNDER_BAR_SYNTAX
                    
                    and more text again...`
                    ,version:'v', 
                        description:'description 1', metadata:'metadata 1'},
                    {title: 'txt2', txt: 'text 2',version:'v', 
                        description:'description 2', metadata:'metadata 2'},
                ];

                function newTXT() {
                    document.getElementById('EDIT_TXT_TITLE').value = '';
                    document.getElementById('EDIT_TXT_TXT').value = '';
                    document.getElementById('EDIT_TXT_VERSION').value = '';
                    document.getElementById('EDIT_TXT_DESCRIPTION').value = '';
                    document.getElementById('EDIT_TXT_METADATA').value = '';
                }

                function EDIT_prevTXT() {
                    if (TXT_IDX > 0) {
                        TXT_IDX--;
                    }else{ //loop to end
                        TXT_IDX = TXT_DOC_DATA.length - 1;
                    } 
                    init_EDIT_VIEW();
                }

                function EDIT_nextTXT() {
                    if (TXT_IDX < TXT_DOC_DATA.length - 1) {
                        TXT_IDX++;
                    }else{ //loop to end
                        TXT_IDX = 0;
                    }
                    init_EDIT_VIEW();
                }

                function saveTXT_EDIT() {
                    const title = document.getElementById('EDIT_TXT_TITLE').value;
                    const txt = document.getElementById('EDIT_TXT_TXT').value;
                    const version = document.getElementById('EDIT_TXT_VERSION').value || '';
                    const description = document.getElementById('EDIT_TXT_DESCRIPTION').value || '';
                    const metadata = document.getElementById('EDIT_TXT_METADATA').value || '';

                    if (title && txt) {
                        const existingIndex = TXT_DOC_DATA.findIndex(doc => doc.title === title);
                        if (existingIndex !== -1) {
                            TXT_DOC_DATA[existingIndex].txt = txt;
                            TXT_DOC_DATA[existingIndex].version = version;
                            TXT_DOC_DATA[existingIndex].description = description;
                            TXT_DOC_DATA[existingIndex].metadata = metadata;
                        } else {
                            TXT_DOC_DATA.push({
                                title: title, txt: txt,
                                version: version, description:description, 
                                metadata: metadata
                            });
                            TXT_IDX = TXT_DOC_DATA.length - 1;
                        }
                    }
                }

                function deleteTXT() {
                    const title = document.getElementById('EDIT_TXT_TITLE').value;
                    const index = TXT_DOC_DATA.findIndex(doc => doc.title === title);
                    if (index !== -1) {
                        TXT_DOC_DATA.splice(index, 1);
                        newTXT();
                        TXT_IDX = 0;
                    }
                }

                function init_EDIT_VIEW() {
                    if(!TXT_DOC_DATA || !TXT_DOC_DATA.length) {return;}
                    const doc = TXT_DOC_DATA[TXT_IDX];
                    document.getElementById('EDIT_TXT_TITLE').value = doc.title;
                    document.getElementById('EDIT_TXT_TXT').value = doc.txt;
                    document.getElementById('EDIT_TXT_VERSION').value = doc.version;
                    document.getElementById('EDIT_TXT_DESCRIPTION').value = doc.description;
                    document.getElementById('EDIT_TXT_METADATA').value = doc.metadata;
                }
            </script>
        </div>
    </div>
</article><!--END EDIT VIEW-->

<article id="NAV_PLAYBACK" class="app-frame scrollBarV" style="display:none;">

    <div class="control-group">
        <label>TITLE:</label>
        <input type="text" id="txtTitle" placeholder="Title..." 
            style="color:burlywood; margin-bottom: 1em;">
        </input>
        <button onclick="PLAY_prevTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;">◀</button>
        <button onclick="PLAY_nextTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;">▶</button>
        <!-- <button onclick="PLAY_prevTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;">◀️</button>
        <button onclick="PLAY_nextTXT()" style="font-size:1.222em;font-weight:bold;line-height: 0.666em;min-width: 4em;text-shadow: -1px 1px 1px blue;">▶️</button> -->
        <button id="toggleSize" onclick="toggleFrameSize()" class="size-btn">
            <span class="maximize">▲</span>
        </button>
    </div>

    <section id="renderTokenFrame" class="scrollBarV"></section>
    <div class="controls">

        <div class="control-row">
            <div class="controlBar">
                <div class="control-group">
                    <label>Speed:</label>
                    <select id="scrollSpeed">
                        <option value="25">Fastest</option>
                        <option value="50">Faster</option>
                        <option value="80">Fast</option>
                        <option value="100" selected>Normal</option>
                        <option value="120">Slow</option>
                        <option value="150">Slower</option>
                        <option value="200">Slowest</option>
                    </select>
                </div>
                <button id="autoScrollBtn">Auto Scroll</button>
                <!-- <button id="toggleSize" onclick="toggleFrameSize()" class="size-btn">
                    <span class="maximize">🔼</span>
                </button> -->
            </div>            
        </div>

        <div id="PAGE_EDIT_CONTROL_ROW" class="control-row">
            <div class="controlBar" style="border:1px solid purple; border-radius:13px;">

                <div class="controls-group" style="    margin-top: 2%;">
                    <label class="checkboxFrame">
                        <input id="selectAll" onchange="toggleAll(this)"type="checkbox" class="">
                        <span class="checkmark"></span>
                        <label for="selectAll" style="margin-left: 1em;
                        margin-top: -2px;">All</label>
                    </label>
                </div>

                <div class="control-group">
                    <label>Size:</label>
                    <select id="fontSizeCOMBO">
                        <option value="1">Small</option>
                        <option value="2">Medium</option>
                        <option value="3">Large</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Height:</label>
                    <select id="lineHeightCOMBO">
                        <option value="1">Single</option>
                        <option value="2">Double</option>
                        <option value="3">Triple</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Color:</label>
                    <select id="colorCOMBO">
                        <option value="aqua">Aqua</option>
                        <option value="lime">Lime</option>
                        <option value="purple">Purple</option>
                        <option value="steelblue">Steel Blue</option>
                        <option value="dodgerblue">Blue</option>
                        <option value="turquoise">Turquoise</option>
                        <option value="cyan">Cyan</option>
                    </select>
                </div>
            </div>            
        </div>

    <div id="KEYBOARD_HINT_ROW" class="control-row">
        <div class="keyboard-hint">Press SPACEBAR to toggle auto-scroll</div>
    </div>
</article> <!--END PLAYBACK VIEW-->
<script>
    let TOKEN_DATASET = [
        {row: 1, txt: ["test [text] 1"], color: '', size: 2, height: 2},
        {row: 2, txt: ["test (text) 2"], color: 'lime', size: 2, height: 2},
        {row: 3, txt: ["test act_of_words 3"],  size: 2, height: 3},
        {row: 4, txt: ["test aWORDZa 4"],  size: 1, height: 1}
    ];

    let scrollAnimationFrame = null;
    let lastTimestamp = null;
    let scrollTopFloat = 0.0;
    let checkboxStates = [];
    let isSelectAllChecked = false;
    let isUserScrolling = false;

    // Add scroll event listener
    document.getElementById('renderTokenFrame').addEventListener('scroll', function(e) {
        if (!scrollAnimationFrame) {
            scrollTopFloat = this.scrollTop;
        }
    });

    function smoothScroll(timestamp) {
        const frame = document.getElementById('renderTokenFrame');
        const speed = parseInt(document.getElementById('scrollSpeed').value);
        
        if (!lastTimestamp) lastTimestamp = timestamp;
        const elapsed = timestamp - lastTimestamp;
        
        // Calculate scroll amount based on speed, Lower speed value = faster scrolling
        const scrollAmount = (elapsed / speed) * 2;

        scrollTopFloat += scrollAmount;
        frame.scrollTop = scrollTopFloat; //cuts to int
        
        // Reset when reaching bottom
        if (frame.scrollTop >= frame.scrollHeight - frame.clientHeight) {
            toggleAutoScroll();
            return; //do not scroll to top
        }
        lastTimestamp = timestamp;
        scrollAnimationFrame = requestAnimationFrame(smoothScroll);
    }

    // Fixed toggle auto scroll
    function toggleAutoScroll() {
        const btn = document.getElementById('autoScrollBtn');
        if (scrollAnimationFrame) {
            cancelAnimationFrame(scrollAnimationFrame);
            scrollAnimationFrame = null;
            lastTimestamp = null;
            btn.textContent = 'Auto Scroll';
            btn.classList.remove('active');
        } else {
            btn.textContent = 'Stop Scrolling';
            btn.classList.add('active');
            scrollAnimationFrame = requestAnimationFrame(smoothScroll);
        }
    }

    // Update speed event listener
    document.getElementById('scrollSpeed').addEventListener('change', () => {
        if (scrollAnimationFrame) {
            lastTimestamp = null;  // Reset timestamp for new speed calculation
        }
    });

    // Initialize 
    generateMockData();
    renderTokens();

    // Add all event listeners
    ['fontSizeCOMBO', 'lineHeightCOMBO', 'colorCOMBO'].forEach(id => {
        document.getElementById(id).addEventListener('click', function(){updateSelectedRows(id)});
    });

    document.getElementById('autoScrollBtn').addEventListener('click', toggleAutoScroll);

    function generateMockData() {
        const colors = ['aqua', 'purple', 'dodgerblue', 'turquoise', 'cyan'];
        for(let i = TOKEN_DATASET.length+1; i <= 14; i++) {
            TOKEN_DATASET.push({
                row: i,
                txt: [`test text ${i}`],
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.floor(Math.random() * 3) + 1,
                height: Math.floor(Math.random() * 3) + 1
            });
        }
    }

    function formatTokenText(text) {
        // debugger;
        let formattedText = text
            .replace(/\[(.*?)\]/g, '<span style="color: lime; font-style: italic">[$1]</span>')
            .replace(/\((.*?)\)/g, '<span style="color: red; font-weight: bold">($1)</span>');
        
        formattedText = formattedText.replace(/(\w*_\w*)/g, '<span style="color: green">$1</span>');
        formattedText = formattedText.replace(/\b(a[a-z]*[A-Z][a-zA-Z]*)\b/g, '<span style="color: lime">$1</span>');
        
        let finalVal = formattedText.trim();
        return finalVal;

    }

    function renderTokens() {
        // Save checkbox states
        const checkboxes = document.querySelectorAll('.spot_checkmark');
        checkboxStates = Array.from(checkboxes).map(cb => ({
            index: cb.dataset.row,
            checked: cb.checked
        })); //END SAVE CHECKBOX STATES

        const frame = document.getElementById('renderTokenFrame');
        frame.innerHTML = '';

        TOKEN_DATASET.forEach(token => {
            const rowElement = document.createElement('div');
            rowElement.className = 'token-row';

            // Format token text with regex matches
            const formattedText = token.txt.map(text => formatTokenText(text)).join(' ');

            rowElement.innerHTML = `
                <span style="margin-top: 0.444em;font-size:0.666em;">${token.row}</span>
                <label class="checkboxFrame">
                    <input type="checkbox" class="spot_checkmark" data-row="${token.row}">
                    <span class="checkmark"></span>
                </label>
                <div class="token-text" 
                     data-row="${token.row}" 
                     onclick="makeEditable(this, event)"
                     style="color: ${token.color};
                            font-size: ${token.size}em;
                            line-height: ${token.height};">
                    ${formattedText}
                </div>`;

            frame.appendChild(rowElement);
        });
        // Restore checkbox states
        checkboxStates.forEach(state => {
            const checkbox = document.querySelector(`.spot_checkmark[data-row="${state.index}"]`);
            if (checkbox) {
                checkbox.checked = state.checked;
            }
        }); //end RESTORE CHECKBOX STATES

        // Restore select all state
        const selectAllCheckbox = document.getElementById('selectAll');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = isSelectAllChecked;
            if(isSelectAllChecked){
                const tokenCheckboxes = document.querySelectorAll('.spot_checkmark');
                tokenCheckboxes.forEach(cb => {
                    cb.checked = isSelectAllChecked;
                });
            }
        }
    }

    function makeEditable(element, event) {
        if (event) {
            event.stopPropagation();
        }
        
        // Don't make editable if clicking inside input
        if (event && event.target.classList.contains('edit-input')) {
            return;
        }
    
        const row = element.dataset.row;
        const originalText = element.innerText;
        element.innerHTML = `
            <input type="text" 
                value="${originalText}" 
                class="edit-input" 
                onclick="event.stopPropagation()"
                style="width: 80%;
                       color: inherit;
                       font-size: inherit;
                       line-height: inherit;">
            <button onclick="saveEdit(${row})" class="save-btn" style="font-size:12px;line-height:8px;">Save</button>
            <button onclick="cancelEdit(${row}, '${originalText}')" class="cancel-btn" style="font-size:12px;line-height:8px;">Cancel</button>
        `;
        element.querySelector('.edit-input').focus();
    }

    function cancelEdit(row, originalText) {
        const element = document.querySelector(`[data-row="${row}"]`);
        if (element) {
            const token = TOKEN_DATASET.find(t => t.row === parseInt(row));
            token.txt = [originalText];
            renderTokens();
        }
    }

    function saveEdit(row) {
        const input = document.querySelector(`[data-row="${row}"] .edit-input`);
        const token = TOKEN_DATASET.find(t => t.row === parseInt(row));
        if (token && input) {
            token.txt = [input.value];
            renderTokens();
        }
    }

    function updateSelectedRows(id) {
        const fontSize = document.getElementById('fontSizeCOMBO').value;
        const lineHeight = document.getElementById('lineHeightCOMBO').value;
        const color = document.getElementById('colorCOMBO').value;
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            const row = parseInt(checkbox.dataset.row);
            const token = TOKEN_DATASET.find(t => t.row === row);
            if (token) {
                if(id==='fontSizeCOMBO') {token.size = parseInt(fontSize);}
                if(id==='lineHeightCOMBO') {token.height = parseInt(lineHeight);}
                if(id==='colorCOMBO') {token.color = color;}
            }
        });

        renderTokens();
    }

    function toggleAll(checkbox) {
        isSelectAllChecked = checkbox.checked;
        const tokenCheckboxes = document.querySelectorAll('.spot_checkmark');
        tokenCheckboxes.forEach(cb => {
            cb.checked = isSelectAllChecked;
        });
    }

    function PLAY_prevTXT() {
        if (TXT_IDX > 0) {
            TXT_IDX--;
        } else {
            TXT_IDX = TXT_DOC_DATA.length - 1;
        }
        renderTokensFromTXT();
    }

    function PLAY_nextTXT() {
        if (TXT_IDX < TXT_DOC_DATA.length - 1) {
            TXT_IDX++;
        } else {
            TXT_IDX = 0;
        }
        renderTokensFromTXT();
    }

    function renderTokensFromTXT() {
        const doc = TXT_DOC_DATA[TXT_IDX];
        document.getElementById('txtTitle').value = doc.title;
        let TOKEN_TXT = doc.txt.split('\n');

        TOKEN_TXT = TOKEN_TXT.filter(token => token.trim() !== '');
        TOKEN_DATASET = TOKEN_TXT.map((line, index) => ({
            row: index + 1,
            txt: [line],
            color: '',
            size: 2,
            height: 2            
        }));
        // TOKEN_DATASET = doc.txt.split('\n').map((line, index) => ({
        //     row: index + 1,
        //     txt: [line],
        //     color: '',
        //     size: 2,
        //     height: 2
        // }));
        renderTokens();
    }

    let isMaximized = false;

    function toggleFrameSize() {
        const frame = document.getElementById('renderTokenFrame');
        const controls = document.getElementById('PAGE_EDIT_CONTROL_ROW');
        const hint = document.getElementById('KEYBOARD_HINT_ROW');
        const btn = document.getElementById('toggleSize');

        isMaximized = !isMaximized;
        // debugger;
        if (isMaximized) {
            frame.classList.add('maximized');
            controls.classList.add('hidden');
            hint.classList.add('hidden');
            btn.innerHTML = '<span>▼</span>';
        } else {
            frame.classList.remove('maximized');
            controls.classList.remove('hidden');
            hint.classList.remove('hidden');
            btn.innerHTML = '<span>▲</span>';
        }
    } toggleFrameSize();
</script>

<footer id="NAV_MENU" style="display:flex;justify-content:space-evenly;width:90%;margin:0 auto; 
background-image: linear-gradient(grey, #052f52, black);height: 2em;
align-items: center;
box-shadow: 0 0 4px 2px steelblue;border-radius:13px;">
      <button class="mainBtn" onclick="showINFO()" 
       style="height:2em;padding: 3px;">
         <span style="border-radius:100%;background:blue;
           border:1px solid grey;margin-right:3px;">
         💠</span><span class="btnTXT hoverTXT">INFO</span>
      </button>
       <!-- <button class="mainBtn" onclick="showCREATE()" 
        style="height:2em;padding: 3px;">
          <span style="border-radius:100%;background:lime;border:1px solid grey;">
            🎇</span> <span class="btnTXT hoverTXT">CREATE</span>
       </button> -->
       <button class="mainBtn" onclick="showEDIT()" 
        style="height:2em;padding: 3px;">
          <span style="border-radius:100%;background:aqua;border:1px solid grey;">
            💫</span> <span class="btnTXT hoverTXT">EDIT</span>
       </button>
       <button class="mainBtn" onclick="showPLAYBACK()" 
        style="height:2em;padding: 3px;">
          <span style="border-radius:100%;background:purple;border:1px solid grey;">
            🎭</span> <span class="btnTXT hoverTXT">PLAYBACK</span>
       </button> 
      </footer> 
      <legal style="color:darkslategray;font-size: 0.666em;
      display:flex;flex: 0 0 auto; margin-top: 1em;">copyright 2020-
      <span id="dateTXTStamp">2025</span>
      <script>
        const dateTXTStamp = document.getElementById('dateTXTStamp');
        dateTXTStamp.innerHTML = new Date().getFullYear();</script>
      
      &nbsp; netcinematics.llc, all rights reserved.</legal>
<script>
const NAV_PLAYBACK = document.getElementById('NAV_PLAYBACK');
// NAV_PLAYBACK.style.display = 'block';//DEFAULT_VIEW
const NAV_EDIT = document.getElementById('NAV_EDIT');
NAV_EDIT.style.display = 'block';//DEFAULT_VIEW
// const NAV_CREATE = document.getElementById('NAV_CREATE');
const NAV_INFO = document.getElementById('NAV_INFO');
function showINFO() {
    NAV_INFO.style.display = 'block';
    // NAV_CREATE.style.display = 'none';
    NAV_EDIT.style.display = 'none';
    NAV_PLAYBACK.style.display = 'none';
}

// function showCREATE() {
//     NAV_INFO.style.display = 'none';
//     NAV_CREATE.style.display = 'block';
//     NAV_EDIT.style.display = 'none';
//     NAV_PLAYBACK.style.display = 'none';
// }

function showEDIT() {
    NAV_INFO.style.display = 'none';
    // NAV_CREATE.style.display = 'none';
    NAV_EDIT.style.display = 'block';
    NAV_PLAYBACK.style.display = 'none';
    init_EDIT_VIEW();
}

function showPLAYBACK() {
    NAV_INFO.style.display = 'none';
    // NAV_CREATE.style.display = 'none';
    NAV_EDIT.style.display = 'none';
    NAV_PLAYBACK.style.display = 'block';
    // init_PLAYBACK_VIEW();
    renderTokensFromTXT();
}
</script>
</body>
</html>